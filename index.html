<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šæµ·äº¤é€šå¤§å­¦ D35 å®¿èˆæ¥¼ - åˆ†å¸ƒå¼æˆ¿é—´çŠ¶æ€ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background-color: #003366;
            color: white;
            padding: 20px 30px;
            border-bottom: 5px solid #b31b1b;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .header h1:before {
            content: "ğŸ«";
            margin-right: 15px;
            font-size: 32px;
        }
        
        .header h2 {
            font-size: 20px;
            font-weight: 500;
            color: #e6f2ff;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            color: #b3d9ff;
            margin-bottom: 5px;
        }
        
        .emergency-info {
            background-color: #fff8e6;
            padding: 15px 30px;
            border-bottom: 1px solid #ffcc80;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .emergency-info div {
            margin: 5px 0;
        }
        
        .phone-number {
            color: #cc3300;
            font-weight: bold;
            font-size: 16px;
            margin-left: 5px;
        }
        
        .note {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        
        .sync-panel {
            background-color: #e8f4fd;
            padding: 15px 30px;
            border-bottom: 1px solid #c2e0ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .syncing { background-color: #ffcc00; animation: pulse 1.5s infinite; }
        .synced { background-color: #28a745; }
        .error { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .last-sync {
            font-size: 13px;
            color: #666;
            margin-left: 15px;
        }
        
        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-id {
            background-color: #4a90e2;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .control-panel {
            padding: 20px 30px;
            background-color: #f0f5ff;
            border-bottom: 1px solid #d9e4ff;
        }
        
        .status-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        
        .status-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .unchecked { background-color: #f8f9fa; color: #6c757d; }
        .checked-normal { background-color: #d4edda; }
        .checked-abnormal { background-color: #f8d7da; }
        .checked-reported { background-color: #fff3cd; }
        .noise { background-color: #cce5ff; }
        
        .facility-color {
            background-color: #e9ecef;
            color: #495057;
        }
        
        .instructions {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .floor-container {
            padding: 20px;
            overflow-x: auto;
        }
        
        .floor {
            margin-bottom: 35px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        
        .floor-header {
            background-color: #2c5282;
            color: white;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .floor-info {
            display: flex;
            align-items: center;
        }
        
        .floor-number {
            background-color: #4a90e2;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .floor-stats {
            font-size: 14px;
            font-weight: normal;
            color: #e6f2ff;
        }
        
        .floor-layout {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .row {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }
        
        .row-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .row-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            padding-left: 5px;
            font-weight: 500;
        }
        
        .room {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 75px;
            min-width: 75px;
            flex: 1;
            position: relative;
        }
        
        .room:hover:not(.facility) {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .room-id {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 14px;
        }
        
        .room-status {
            font-size: 11px;
            margin-top: 3px;
            padding: 2px 5px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }
        
        .last-updated-by {
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 10px;
            color: #666;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1px 4px;
            border-radius: 2px;
        }
        
        /* ç‰¹æ®Šè®¾æ–½æ ·å¼ */
        .facility {
            background-color: #e9ecef;
            border: 2px dashed #adb5bd;
            cursor: default;
            min-width: 90px;
        }
        
        .toilet {
            background-color: #e7f5ff;
            border-color: #4dabf7;
        }
        
        .elevator {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .common-area {
            background-color: #f3e8ff;
            border-color: #9c36b5;
        }
        
        .footer {
            background-color: #f0f5ff;
            padding: 20px 30px;
            text-align: center;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #d9e4ff;
        }
        
        .footer p {
            margin: 5px 0;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .stats-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        
        .unchecked .stat-value { color: #6c757d; }
        .checked-normal .stat-value { color: #28a745; }
        .checked-abnormal .stat-value { color: #dc3545; }
        .checked-reported .stat-value { color: #ffc107; }
        .noise .stat-value { color: #17a2b8; }
        
        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: #3a7bc8;
        }
        
        .action-btn.sync {
            background-color: #17a2b8;
        }
        
        .action-btn.sync:hover {
            background-color: #138496;
        }
        
        .action-btn.reset {
            background-color: #6c757d;
        }
        
        .action-btn.reset:hover {
            background-color: #5a6268;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .row {
                flex-wrap: wrap;
            }
            
            .room {
                min-width: 70px;
                min-height: 70px;
                padding: 8px 4px;
            }
            
            .facility {
                min-width: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            
            .header h2 {
                font-size: 18px;
            }
            
            .status-legend {
                flex-direction: column;
                gap: 8px;
            }
            
            .floor-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .room {
                min-width: 65px;
                min-height: 65px;
                font-size: 12px;
                padding: 6px 3px;
            }
            
            .facility {
                min-width: 70px;
            }
            
            .room-id {
                font-size: 12px;
            }
            
            .room-status {
                font-size: 10px;
                padding: 1px 3px;
            }
            
            .sync-panel {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        /* å®¿èˆç¼–å·æ ·å¼ */
        .dorm-number {
            font-size: 12px;
            color: #555;
            margin-top: 2px;
        }
        
        /* èµ°å»Šæ ‡è¯† */
        .corridor {
            background-color: #f1f3f5;
            border: 2px dotted #868e96;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
            margin: 5px 0;
        }
        
        /* æ•°æ®ç®¡ç†é¢æ¿ */
        .data-management {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }
        
        .data-management h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .data-btn {
            padding: 6px 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .data-btn:hover {
            background-color: #5a6268;
        }
        
        .data-btn.export {
            background-color: #28a745;
        }
        
        .data-btn.export:hover {
            background-color: #218838;
        }
        
        .data-btn.import {
            background-color: #17a2b8;
        }
        
        .data-btn.import:hover {
            background-color: #138496;
        }
        
        /* ç”¨æˆ·æ´»åŠ¨è®°å½• */
        .activity-log {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-log h4 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .activity-item {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
            color: #666;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            color: #999;
            font-size: 12px;
        }
        
        .activity-user {
            font-weight: bold;
            color: #4a90e2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä¸Šæµ·äº¤é€šå¤§å­¦ D35 å®¿èˆæ¥¼ - åˆ†å¸ƒå¼æˆ¿é—´çŠ¶æ€ç›‘æ§ç³»ç»Ÿ</h1>
            <h2>æœ¬åœ°åŒ–éƒ¨ç½²ç‰ˆæœ¬ - å¤šç”¨æˆ·æ•°æ®åŒæ­¥</h2>
            <p>åŸºäºLocalStorageçš„æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥</p>
        </div>
        
        <div class="emergency-info">
            <div>
                <strong>æ ¡å›­æŠ¥è­¦ç”µè¯ï¼š</strong><span class="phone-number">54749110</span>
            </div>
            <div>
                <strong>å…¬å®‰æŠ¥è­¦ç”µè¯ï¼š</strong><span class="phone-number">110</span>
            </div>
            <div>
                <strong>ç«è­¦ç”µè¯ï¼š</strong><span class="phone-number">119</span>
            </div>
            <div class="note">
                <strong>ç³»ç»Ÿè¯´æ˜ï¼š</strong>æ•°æ®æœ¬åœ°å­˜å‚¨ï¼Œæ¯30ç§’è‡ªåŠ¨åŒæ­¥ï¼Œæ”¯æŒå¤šç”¨æˆ·åä½œ
            </div>
        </div>
        
        <div class="sync-panel">
            <div class="sync-status">
                <div class="sync-indicator synced" id="syncIndicator"></div>
                <span id="syncStatusText">æ•°æ®å·²åŒæ­¥</span>
                <div class="last-sync" id="lastSyncTime">ä¸Šæ¬¡åŒæ­¥: åˆšåˆš</div>
            </div>
            
            <div class="user-controls">
                <div>ç”¨æˆ·ID: <span class="user-id" id="userIdDisplay">åŠ è½½ä¸­...</span></div>
                <button class="action-btn sync" id="forceSync">ç«‹å³åŒæ­¥</button>
                <button class="action-btn" id="changeUser">åˆ‡æ¢ç”¨æˆ·</button>
            </div>
        </div>
        
        <div class="control-panel">
            <h3>æˆ¿é—´çŠ¶æ€å›¾ä¾‹ï¼š</h3>
            <div class="status-legend">
                <div class="status-item">
                    <div class="status-color unchecked"></div>
                    <span>æœªæ£€æŸ¥</span>
                </div>
                <div class="status-item">
                    <div class="status-color checked-normal"></div>
                    <span>å·²æ£€æŸ¥ï¼Œæ­£å¸¸</span>
                </div>
                <div class="status-item">
                    <div class="status-color checked-abnormal"></div>
                    <span>å·²æ£€æŸ¥ï¼Œå¼‚å¸¸</span>
                </div>
                <div class="status-item">
                    <div class="status-color checked-reported"></div>
                    <span>å·²æ£€æŸ¥ï¼Œå·²æŠ¥ä¿®</span>
                </div>
                <div class="status-item">
                    <div class="status-color noise"></div>
                    <span>æ­£å¸¸ï¼Œä½†é™„è¿‘æœ‰å™ªéŸ³</span>
                </div>
                <div class="status-item">
                    <div class="status-color facility-color"></div>
                    <span>å…¬å…±è®¾æ–½</span>
                </div>
            </div>
            
            <div class="instructions">
                <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>ç‚¹å‡»å®¿èˆæˆ¿é—´å¯ä»¥å¾ªç¯åˆ‡æ¢æˆ¿é—´çŠ¶æ€ã€‚æ‰€æœ‰æ›´æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¹¶ä¸å…¶ä»–ç”¨æˆ·åŒæ­¥ã€‚</p>
                <p><strong>åŒæ­¥æœºåˆ¶ï¼š</strong>ç³»ç»Ÿæ¯30ç§’è‡ªåŠ¨åŒæ­¥æ•°æ®ã€‚æˆ¿é—´ä¸Šçš„æ ‡ç­¾æ˜¾ç¤ºæœ€åä¿®æ”¹è€…ã€‚</p>
                
                <div class="action-buttons">
                    <button class="action-btn" id="markAllNormal">æ ‡è®°æ‰€æœ‰ä¸º"å·²æ£€æŸ¥ï¼Œæ­£å¸¸"</button>
                    <button class="action-btn reset" id="resetAll">é‡ç½®æ‰€æœ‰ä¸º"æœªæ£€æŸ¥"</button>
                </div>
                
                <div class="data-management">
                    <h4>æ•°æ®ç®¡ç†</h4>
                    <div class="data-actions">
                        <button class="data-btn export" id="exportData">å¯¼å‡ºæ•°æ® (JSON)</button>
                        <button class="data-btn import" id="importData">å¯¼å…¥æ•°æ®</button>
                        <button class="data-btn" id="clearLocalData">æ¸…é™¤æœ¬åœ°æ•°æ®</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;">
                    </div>
                </div>
                
                <div class="activity-log">
                    <h4>æœ€è¿‘æ´»åŠ¨è®°å½•</h4>
                    <div id="activityList">
                        <!-- æ´»åŠ¨è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            
            <div class="stats-panel" id="statsPanel">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="floor-container" id="floorContainer">
            <!-- æ¥¼å±‚å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="footer">
            <p>ä¸Šæµ·äº¤é€šå¤§å­¦ä¿å«å¤„</p>
            <p>æœ¬åœ°åŒ–éƒ¨ç½²ç‰ˆæœ¬ | æ•°æ®è‡ªåŠ¨ä¿å­˜ä¸åŒæ­¥ | æœ€åæ›´æ–°: <span id="dataVersion">åŠ è½½ä¸­...</span></p>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»Ÿé…ç½® ====================
        const CONFIG = {
            STORAGE_KEY: 'SJTU_D35_DORM_SYSTEM',
            SYNC_INTERVAL: 30000, // 30ç§’è‡ªåŠ¨åŒæ­¥
            ACTIVITY_MAX_ITEMS: 10,
            SYSTEM_VERSION: '1.0.0'
        };
        
        // ==================== æˆ¿é—´çŠ¶æ€å®šä¹‰ ====================
        const ROOM_STATUSES = [
            { id: 0, name: "æœªæ£€æŸ¥", className: "unchecked" },
            { id: 1, name: "å·²æ£€æŸ¥ï¼Œæ­£å¸¸", className: "checked-normal" },
            { id: 2, name: "å·²æ£€æŸ¥ï¼Œå¼‚å¸¸", className: "checked-abnormal" },
            { id: 3, name: "å·²æ£€æŸ¥ï¼Œå·²æŠ¥ä¿®", className: "checked-reported" },
            { id: 4, name: "æ­£å¸¸ï¼Œä½†é™„è¿‘æœ‰å™ªéŸ³", className: "noise" }
        ];
        
        // ==================== æ¥¼å±‚å¸ƒå±€æ•°æ® ====================
        const FLOOR_LAYOUT = {
            row1: { count: 11, type: 'dorm', title: 'å®¿èˆæˆ¿é—´ (1-11å·)' },
            row2: { count: 10, type: 'dorm', title: 'å®¿èˆæˆ¿é—´ (12-21å·)' },
            row3: {
                items: [
                    { type: 'toilet', label: 'å«ç”Ÿé—´' },
                    { type: 'elevator', label: 'ç”µæ¢¯é—´' },
                    { type: 'dorm', count: 2 },
                    { type: 'toilet', label: 'å«ç”Ÿé—´' },
                    { type: 'dorm', count: 4 },
                    { type: 'common-area', label: 'äº¤æµåŒº' },
                    { type: 'elevator', label: 'ç”µæ¢¯é—´' },
                    { type: 'toilet', label: 'å«ç”Ÿé—´' }
                ],
                title: 'å…¬å…±åŒºåŸŸä¸å®¿èˆ (22-27å·)'
            }
        };
        
        // ==================== å…¨å±€å˜é‡ ====================
        let currentUser = null;
        let systemData = null;
        let syncTimer = null;
        let isSyncing = false;
        
        // ==================== ç”¨æˆ·ç®¡ç† ====================
        function initializeUser() {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·ID
            let userId = localStorage.getItem('SJTU_DORM_USER_ID');
            
            if (!userId) {
                // ç”Ÿæˆæ–°ç”¨æˆ·ID
                userId = 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('SJTU_DORM_USER_ID', userId);
            }
            
            currentUser = {
                id: userId,
                name: userId.split('_')[0] + '#' + userId.split('_')[2],
                lastActive: new Date().toISOString()
            };
            
            document.getElementById('userIdDisplay').textContent = currentUser.name;
            
            return currentUser;
        }
        
        // ==================== æ•°æ®ç®¡ç†ç³»ç»Ÿ ====================
        
        // åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
        function initializeSystemData() {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            const savedData = localStorage.getItem(CONFIG.STORAGE_KEY);
            
            if (savedData) {
                try {
                    systemData = JSON.parse(savedData);
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®æˆåŠŸ');
                    
                    // éªŒè¯æ•°æ®å®Œæ•´æ€§
                    if (!validateSystemData(systemData)) {
                        console.warn('æ•°æ®éªŒè¯å¤±è´¥ï¼Œé‡æ–°åˆå§‹åŒ–');
                        systemData = createNewSystemData();
                    } else {
                        // æ›´æ–°æ•°æ®ç‰ˆæœ¬
                        updateDataVersion();
                    }
                } catch (e) {
                    console.error('è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', e);
                    systemData = createNewSystemData();
                }
            } else {
                // åˆ›å»ºæ–°çš„ç³»ç»Ÿæ•°æ®
                systemData = createNewSystemData();
            }
            
            // ä¿å­˜åˆå§‹æ•°æ®
            saveSystemData();
            
            return systemData;
        }
        
        // åˆ›å»ºæ–°çš„ç³»ç»Ÿæ•°æ®
        function createNewSystemData() {
            const floors = [];
            
            // ä¸ºæ¯ä¸ªæ¥¼å±‚ç”Ÿæˆæ•°æ®ï¼ˆä»13å±‚åˆ°1å±‚ï¼‰
            for (let floorNum = 13; floorNum >= 1; floorNum--) {
                const floorRooms = [];
                
                // ç¬¬ä¸€è¡Œï¼š11ä¸ªå®¿èˆ
                for (let i = 1; i <= FLOOR_LAYOUT.row1.count; i++) {
                    const roomNum = floorNum * 100 + i;
                    
                    floorRooms.push({
                        id: roomNum,
                        floor: floorNum,
                        number: i,
                        type: 'dorm',
                        status: 0, // é»˜è®¤æœªæ£€æŸ¥
                        label: `${roomNum}å®¤`,
                        displayLabel: `${i}å·`,
                        lastUpdated: null,
                        lastUpdatedBy: null,
                        history: []
                    });
                }
                
                // ç¬¬äºŒè¡Œï¼š10ä¸ªå®¿èˆ
                for (let i = 1; i <= FLOOR_LAYOUT.row2.count; i++) {
                    const roomNum = floorNum * 100 + FLOOR_LAYOUT.row1.count + i;
                    
                    floorRooms.push({
                        id: roomNum,
                        floor: floorNum,
                        number: FLOOR_LAYOUT.row1.count + i,
                        type: 'dorm',
                        status: 0,
                        label: `${roomNum}å®¤`,
                        displayLabel: `${FLOOR_LAYOUT.row1.count + i}å·`,
                        lastUpdated: null,
                        lastUpdatedBy: null,
                        history: []
                    });
                }
                
                // ç¬¬ä¸‰è¡Œï¼šå…¬å…±è®¾æ–½å’Œ6ä¸ªå®¿èˆ
                let dormCount = 0;
                let itemIndex = 0;
                
                FLOOR_LAYOUT.row3.items.forEach(item => {
                    if (item.type === 'dorm') {
                        // å®¿èˆæˆ¿é—´
                        for (let i = 1; i <= item.count; i++) {
                            dormCount++;
                            const roomNum = floorNum * 100 + FLOOR_LAYOUT.row1.count + FLOOR_LAYOUT.row2.count + dormCount;
                            
                            floorRooms.push({
                                id: roomNum,
                                floor: floorNum,
                                number: FLOOR_LAYOUT.row1.count + FLOOR_LAYOUT.row2.count + dormCount,
                                type: 'dorm',
                                status: 0,
                                label: `${roomNum}å®¤`,
                                displayLabel: `${FLOOR_LAYOUT.row1.count + FLOOR_LAYOUT.row2.count + dormCount}å·`,
                                lastUpdated: null,
                                lastUpdatedBy: null,
                                history: []
                            });
                        }
                    } else {
                        // å…¬å…±è®¾æ–½
                        itemIndex++;
                        floorRooms.push({
                            id: `${floorNum}-${item.type}-${itemIndex}`,
                            floor: floorNum,
                            type: item.type,
                            label: item.label,
                            isFacility: true
                        });
                    }
                });
                
                floors.push({
                    number: floorNum,
                    rooms: floorRooms
                });
            }
            
            return {
                version: CONFIG.SYSTEM_VERSION,
                created: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                floors: floors,
                activityLog: [],
                statistics: {
                    totalChanges: 0,
                    totalRooms: 0,
                    statusCount: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 }
                }
            };
        }
        
        // éªŒè¯ç³»ç»Ÿæ•°æ®å®Œæ•´æ€§
        function validateSystemData(data) {
            if (!data || typeof data !== 'object') return false;
            if (!data.version || !data.floors || !Array.isArray(data.floors)) return false;
            if (data.floors.length !== 13) return false; // 13å±‚æ¥¼
            
            // æ£€æŸ¥æ¯å±‚æ¥¼æˆ¿é—´æ•°é‡
            for (let floor of data.floors) {
                if (!floor.rooms || !Array.isArray(floor.rooms)) return false;
                
                // æ¯å±‚æ¥¼åº”è¯¥æœ‰27ä¸ªå®¿èˆ + å…¬å…±è®¾æ–½
                const dormCount = floor.rooms.filter(r => r.type === 'dorm').length;
                if (dormCount !== 27) return false;
            }
            
            return true;
        }
        
        // ä¿å­˜ç³»ç»Ÿæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveSystemData() {
            if (!systemData) return;
            
            systemData.lastUpdated = new Date().toISOString();
            
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(systemData));
                console.log('æ•°æ®ä¿å­˜æˆåŠŸ');
                
                // æ›´æ–°æ˜¾ç¤º
                updateDataVersionDisplay();
                
                return true;
            } catch (e) {
                console.error('æ•°æ®ä¿å­˜å¤±è´¥:', e);
                showNotification('æ•°æ®ä¿å­˜å¤±è´¥: ' + e.message, 'error');
                return false;
            }
        }
        
        // æ›´æ–°æ•°æ®ç‰ˆæœ¬æ˜¾ç¤º
        function updateDataVersion() {
            if (!systemData) return;
            
            systemData.version = CONFIG.SYSTEM_VERSION;
            updateDataVersionDisplay();
        }
        
        function updateDataVersionDisplay() {
            if (!systemData) return;
            
            const date = new Date(systemData.lastUpdated);
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('dataVersion').textContent = 
                `v${systemData.version} (${timeStr})`;
        }
        
        // åŒæ­¥æ•°æ®ï¼ˆæ¨¡æ‹Ÿå¤šç”¨æˆ·åŒæ­¥ï¼‰
        function syncData() {
            if (isSyncing) return;
            
            isSyncing = true;
            updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            setTimeout(() => {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
                // ç°åœ¨åªæ˜¯æ¨¡æ‹ŸåŒæ­¥è¿‡ç¨‹
                
                // æ›´æ–°åŒæ­¥æ—¶é—´
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                document.getElementById('lastSyncTime').textContent = `ä¸Šæ¬¡åŒæ­¥: ${timeStr}`;
                
                isSyncing = false;
                updateSyncStatus('synced', 'æ•°æ®å·²åŒæ­¥');
                
                // è§¦å‘æ•°æ®æ£€æŸ¥ï¼ˆæŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·æ›´æ–°ï¼‰
                checkForExternalChanges();
                
            }, 500);
        }
        
        // æ£€æŸ¥å¤–éƒ¨å˜æ›´ï¼ˆæ¨¡æ‹Ÿå…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼‰
        function checkForExternalChanges() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            // ç°åœ¨åªæ˜¯éšæœºæ¨¡æ‹Ÿä¸€äº›å¤–éƒ¨å˜æ›´ï¼ˆ10%æ¦‚ç‡ï¼‰
            if (Math.random() < 0.1) {
                simulateExternalChange();
            }
        }
        
        // æ¨¡æ‹Ÿå¤–éƒ¨å˜æ›´ï¼ˆå…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼‰
        function simulateExternalChange() {
            // éšæœºé€‰æ‹©ä¸€ä¸ªæˆ¿é—´å¹¶ä¿®æ”¹çŠ¶æ€
            const floorIndex = Math.floor(Math.random() * systemData.floors.length);
            const floor = systemData.floors[floorIndex];
            
            const dormRooms = floor.rooms.filter(r => r.type === 'dorm');
            if (dormRooms.length === 0) return;
            
            const roomIndex = Math.floor(Math.random() * dormRooms.length);
            const room = dormRooms[roomIndex];
            
            // éšæœºæ–°çŠ¶æ€
            const newStatus = Math.floor(Math.random() * ROOM_STATUSES.length);
            
            // è®°å½•å˜æ›´
            const changeRecord = {
                timestamp: new Date().toISOString(),
                user: 'å¤–éƒ¨ç”¨æˆ·',
                roomId: room.id,
                fromStatus: room.status,
                toStatus: newStatus
            };
            
            // æ›´æ–°æˆ¿é—´çŠ¶æ€
            room.status = newStatus;
            room.lastUpdated = new Date().toISOString();
            room.lastUpdatedBy = 'å¤–éƒ¨ç”¨æˆ·';
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            if (!room.history) room.history = [];
            room.history.push(changeRecord);
            
            // æ·»åŠ åˆ°æ´»åŠ¨æ—¥å¿—
            addActivityLog(`å¤–éƒ¨ç”¨æˆ· ä¿®æ”¹äº†æˆ¿é—´ ${room.id} çš„çŠ¶æ€`);
            
            // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
            saveSystemData();
            renderFloors();
            renderStatsPanel();
            renderActivityLog();
            
            showNotification(`æ£€æµ‹åˆ°å¤–éƒ¨æ›´æ–°: æˆ¿é—´ ${room.id} çŠ¶æ€å·²å˜æ›´`, 'info');
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            indicator.classList.remove('syncing', 'synced', 'error');
            
            // æ·»åŠ æ–°çŠ¶æ€ç±»
            indicator.classList.add(status);
            statusText.textContent = text;
        }
        
        // ==================== æˆ¿é—´çŠ¶æ€ç®¡ç† ====================
        
        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        function updateRoomStatus(roomId, newStatus) {
            if (!systemData || !currentUser) return false;
            
            // æŸ¥æ‰¾æˆ¿é—´
            let targetRoom = null;
            let targetFloor = null;
            
            for (let floor of systemData.floors) {
                const room = floor.rooms.find(r => r.id === roomId);
                if (room && room.type === 'dorm') {
                    targetRoom = room;
                    targetFloor = floor;
                    break;
                }
            }
            
            if (!targetRoom) {
                console.error('æœªæ‰¾åˆ°æˆ¿é—´:', roomId);
                return false;
            }
            
            const oldStatus = targetRoom.status;
            
            // è®°å½•å˜æ›´
            const changeRecord = {
                timestamp: new Date().toISOString(),
                user: currentUser.name,
                roomId: roomId,
                fromStatus: oldStatus,
                toStatus: newStatus
            };
            
            // æ›´æ–°æˆ¿é—´æ•°æ®
            targetRoom.status = newStatus;
            targetRoom.lastUpdated = new Date().toISOString();
            targetRoom.lastUpdatedBy = currentUser.name;
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            if (!targetRoom.history) targetRoom.history = [];
            targetRoom.history.push(changeRecord);
            
            // æ›´æ–°ç»Ÿè®¡
            systemData.statistics.totalChanges++;
            
            // æ·»åŠ åˆ°æ´»åŠ¨æ—¥å¿—
            addActivityLog(`${currentUser.name} ä¿®æ”¹äº†æˆ¿é—´ ${roomId} çš„çŠ¶æ€`);
            
            // ä¿å­˜æ•°æ®
            saveSystemData();
            
            // è§¦å‘åŒæ­¥
            if (!isSyncing) {
                syncData();
            }
            
            return true;
        }
        
        // æ·»åŠ æ´»åŠ¨æ—¥å¿—
        function addActivityLog(message) {
            if (!systemData) return;
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                message: message,
                user: currentUser ? currentUser.name : 'ç³»ç»Ÿ'
            };
            
            systemData.activityLog.unshift(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (systemData.activityLog.length > CONFIG.ACTIVITY_MAX_ITEMS * 3) {
                systemData.activityLog = systemData.activityLog.slice(0, CONFIG.ACTIVITY_MAX_ITEMS);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            renderActivityLog();
        }
        
        // ==================== æ¸²æŸ“å‡½æ•° ====================
        
        // æ¸²æŸ“æ¥¼å±‚
        function renderFloors() {
            const container = document.getElementById('floorContainer');
            if (!container || !systemData) return;
            
            container.innerHTML = '';
            
            systemData.floors.forEach(floor => {
                const floorElement = document.createElement('div');
                floorElement.className = 'floor';
                
                // æ¥¼å±‚ç»Ÿè®¡
                const floorStats = calculateFloorStats(floor);
                
                // æ¥¼å±‚æ ‡é¢˜
                const floorHeader = document.createElement('div');
                floorHeader.className = 'floor-header';
                floorHeader.innerHTML = `
                    <div class="floor-info">
                        <div class="floor-number">${floor.number}</div>
                        <span>ç¬¬ ${floor.number} å±‚ - å®¿èˆæˆ¿é—´åˆ†å¸ƒ</span>
                    </div>
                    <div class="floor-stats">
                        å®¿èˆï¼š${floorStats.dormCount}é—´ | 
                        æ­£å¸¸ï¼š${floorStats.normal}é—´ | 
                        å¼‚å¸¸ï¼š${floorStats.abnormal}é—´
                    </div>
                `;
                
                // æ¥¼å±‚å¸ƒå±€
                const floorLayout = document.createElement('div');
                floorLayout.className = 'floor-layout';
                
                // ç¬¬ä¸€è¡Œï¼š11ä¸ªå®¿èˆ
                const row1Wrapper = document.createElement('div');
                row1Wrapper.className = 'row-wrapper';
                row1Wrapper.innerHTML = `<div class="row-title">${FLOOR_LAYOUT.row1.title}</div>`;
                
                const row1 = document.createElement('div');
                row1.className = 'row';
                
                // è·å–ç¬¬ä¸€è¡Œçš„å®¿èˆï¼ˆå‰11ä¸ªï¼‰
                const row1Rooms = floor.rooms.filter(r => r.type === 'dorm' && r.number <= 11);
                row1Rooms.sort((a, b) => a.number - b.number);
                
                row1Rooms.forEach(room => {
                    const roomElement = createRoomElement(room);
                    row1.appendChild(roomElement);
                });
                
                row1Wrapper.appendChild(row1);
                
                // ç¬¬äºŒè¡Œï¼š10ä¸ªå®¿èˆï¼ˆ12-21å·ï¼‰
                const row2Wrapper = document.createElement('div');
                row2Wrapper.className = 'row-wrapper';
                row2Wrapper.innerHTML = `<div class="row-title">${FLOOR_LAYOUT.row2.title}</div>`;
                
                const row2 = document.createElement('div');
                row2.className = 'row';
                
                // è·å–ç¬¬äºŒè¡Œçš„å®¿èˆï¼ˆ12-21å·ï¼‰
                const row2Rooms = floor.rooms.filter(r => r.type === 'dorm' && r.number >= 12 && r.number <= 21);
                row2Rooms.sort((a, b) => a.number - b.number);
                
                row2Rooms.forEach(room => {
                    const roomElement = createRoomElement(room);
                    row2.appendChild(roomElement);
                });
                
                row2Wrapper.appendChild(row2);
                
                // èµ°å»Šæ ‡è¯†
                const corridor = document.createElement('div');
                corridor.className = 'corridor';
                corridor.textContent = 'â”â”â”â”â”â” èµ°å»Š â”â”â”â”â”â”';
                
                // ç¬¬ä¸‰è¡Œï¼šå…¬å…±è®¾æ–½å’Œ6ä¸ªå®¿èˆï¼ˆ22-27å·ï¼‰
                const row3Wrapper = document.createElement('div');
                row3Wrapper.className = 'row-wrapper';
                row3Wrapper.innerHTML = `<div class="row-title">${FLOOR_LAYOUT.row3.title}</div>`;
                
                const row3 = document.createElement('div');
                row3.className = 'row';
                
                // è·å–ç¬¬ä¸‰è¡Œçš„æ‰€æœ‰æˆ¿é—´ï¼ˆåŒ…æ‹¬å…¬å…±è®¾æ–½å’Œå®¿èˆ22-27å·ï¼‰
                // è¿™é‡Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§FLOOR_LAYOUT.row3.itemsçš„é¡ºåºæ¥åˆ›å»º
                
                // è·å–22-27å·å®¿èˆ
                const row3Dorms = floor.rooms.filter(r => r.type === 'dorm' && r.number >= 22 && r.number <= 27);
                row3Dorms.sort((a, b) => a.number - b.number);
                
                // è·å–å…¬å…±è®¾æ–½
                const facilities = floor.rooms.filter(r => r.isFacility);
                
                // æŒ‰ç…§å¸ƒå±€é¡ºåºåˆ›å»ºå…ƒç´ 
                let dormIndex = 0;
                
                FLOOR_LAYOUT.row3.items.forEach(item => {
                    if (item.type === 'dorm') {
                        // æ·»åŠ å®¿èˆ
                        for (let i = 0; i < item.count; i++) {
                            if (dormIndex < row3Dorms.length) {
                                const roomElement = createRoomElement(row3Dorms[dormIndex]);
                                row3.appendChild(roomElement);
                                dormIndex++;
                            }
                        }
                    } else {
                        // æ·»åŠ å…¬å…±è®¾æ–½
                        // æŸ¥æ‰¾å¯¹åº”ç±»å‹çš„å…¬å…±è®¾æ–½
                        const facility = facilities.find(f => f.type === item.type);
                        if (facility) {
                            const facilityElement = createRoomElement(facility);
                            row3.appendChild(facilityElement);
                        }
                    }
                });
                
                row3Wrapper.appendChild(row3);
                
                floorLayout.appendChild(row1Wrapper);
                floorLayout.appendChild(row2Wrapper);
                floorLayout.appendChild(corridor);
                floorLayout.appendChild(row3Wrapper);
                
                floorElement.appendChild(floorHeader);
                floorElement.appendChild(floorLayout);
                container.appendChild(floorElement);
            });
        }
        
        // è®¡ç®—æ¥¼å±‚ç»Ÿè®¡
        function calculateFloorStats(floor) {
            let dormCount = 0;
            let normal = 0;
            let abnormal = 0;
            
            floor.rooms.forEach(room => {
                if (room.type === 'dorm') {
                    dormCount++;
                    
                    if (room.status === 1 || room.status === 4) {
                        normal++;
                    } else if (room.status === 2) {
                        abnormal++;
                    }
                }
            });
            
            return { dormCount, normal, abnormal };
        }
        
        // åˆ›å»ºæˆ¿é—´å…ƒç´ 
        function createRoomElement(room) {
            const roomElement = document.createElement('div');
            
            if (room.isFacility) {
                // å…¬å…±è®¾æ–½
                roomElement.className = `room facility ${room.type}`;
                let icon = 'ğŸ¢';
                if (room.type === 'toilet') icon = 'ğŸš»';
                else if (room.type === 'elevator') icon = 'ğŸ›—';
                else if (room.type === 'common-area') icon = 'ğŸ’¬';
                
                roomElement.innerHTML = `
                    <div class="room-id">${room.label}</div>
                    <div style="font-size:11px; margin-top:3px;">${icon}</div>
                `;
            } else {
                // å®¿èˆæˆ¿é—´
                const status = ROOM_STATUSES[room.status];
                roomElement.className = `room ${status.className}`;
                roomElement.dataset.id = room.id;
                roomElement.dataset.status = room.status;
                
                let lastUpdatedByHtml = '';
                if (room.lastUpdatedBy) {
                    lastUpdatedByHtml = `<div class="last-updated-by">${room.lastUpdatedBy}</div>`;
                }
                
                roomElement.innerHTML = `
                    ${lastUpdatedByHtml}
                    <div class="room-id">${room.label}</div>
                    <div class="dorm-number">${room.displayLabel || room.number + 'å·'}</div>
                    <div class="room-status">${status.name}</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶åˆ‡æ¢çŠ¶æ€
                roomElement.addEventListener('click', function() {
                    changeRoomStatus(this);
                });
            }
            
            return roomElement;
        }
        
        // æ¸²æŸ“ç»Ÿè®¡é¢æ¿
        function renderStatsPanel() {
            const statsPanel = document.getElementById('statsPanel');
            if (!statsPanel || !systemData) return;
            
            // é‡æ–°è®¡ç®—ç»Ÿè®¡
            let totalRooms = 0;
            let unchecked = 0;
            let checkedNormal = 0;
            let checkedAbnormal = 0;
            let checkedReported = 0;
            let noise = 0;
            
            systemData.floors.forEach(floor => {
                floor.rooms.forEach(room => {
                    if (room.type === 'dorm') {
                        totalRooms++;
                        
                        switch(room.status) {
                            case 0: unchecked++; break;
                            case 1: checkedNormal++; break;
                            case 2: checkedAbnormal++; break;
                            case 3: checkedReported++; break;
                            case 4: noise++; break;
                        }
                    }
                });
            });
            
            statsPanel.innerHTML = `
                <div class="stat-item unchecked">
                    <div class="stat-value">${unchecked}</div>
                    <div class="stat-label">æœªæ£€æŸ¥</div>
                </div>
                <div class="stat-item checked-normal">
                    <div class="stat-value">${checkedNormal}</div>
                    <div class="stat-label">å·²æ£€æŸ¥ï¼Œæ­£å¸¸</div>
                </div>
                <div class="stat-item checked-abnormal">
                    <div class="stat-value">${checkedAbnormal}</div>
                    <div class="stat-label">å·²æ£€æŸ¥ï¼Œå¼‚å¸¸</div>
                </div>
                <div class="stat-item checked-reported">
                    <div class="stat-value">${checkedReported}</div>
                    <div class="stat-label">å·²æ£€æŸ¥ï¼Œå·²æŠ¥ä¿®</div>
                </div>
                <div class="stat-item noise">
                    <div class="stat-value">${noise}</div>
                    <div class="stat-label">é™„è¿‘æœ‰å™ªéŸ³</div>
                </div>
                <div class="stat-item" style="background-color:#f8f9fa;">
                    <div class="stat-value">${totalRooms}</div>
                    <div class="stat-label">æ€»æˆ¿é—´æ•°</div>
                </div>
            `;
        }
        
        // æ¸²æŸ“æ´»åŠ¨æ—¥å¿—
        function renderActivityLog() {
            const activityList = document.getElementById('activityList');
            if (!activityList || !systemData) return;
            
            activityList.innerHTML = '';
            
            const recentActivities = systemData.activityLog.slice(0, CONFIG.ACTIVITY_MAX_ITEMS);
            
            if (recentActivities.length === 0) {
                activityList.innerHTML = '<div class="activity-item">æš‚æ— æ´»åŠ¨è®°å½•</div>';
                return;
            }
            
            recentActivities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const date = new Date(activity.timestamp);
                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                activityItem.innerHTML = `
                    <div><span class="activity-user">${activity.user}</span> ${activity.message}</div>
                    <div class="activity-time">${timeStr}</div>
                `;
                
                activityList.appendChild(activityItem);
            });
        }
        
        // ==================== äº‹ä»¶å¤„ç† ====================
        
        // æ”¹å˜æˆ¿é—´çŠ¶æ€
        function changeRoomStatus(roomElement) {
            const currentStatus = parseInt(roomElement.dataset.status);
            const newStatus = (currentStatus + 1) % ROOM_STATUSES.length;
            const roomId = roomElement.querySelector('.room-id').textContent;
            
            // æ›´æ–°æˆ¿é—´çŠ¶æ€
            const success = updateRoomStatus(parseInt(roomId), newStatus);
            
            if (success) {
                // æ›´æ–°UI
                const newStatusInfo = ROOM_STATUSES[newStatus];
                
                roomElement.dataset.status = newStatus;
                
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                ROOM_STATUSES.forEach(status => {
                    roomElement.classList.remove(status.className);
                });
                
                // æ·»åŠ æ–°çŠ¶æ€ç±»
                roomElement.classList.add(newStatusInfo.className);
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                const statusElement = roomElement.querySelector('.room-status');
                statusElement.textContent = newStatusInfo.name;
                
                // æ›´æ–°æœ€åä¿®æ”¹è€…
                const lastUpdatedByElement = roomElement.querySelector('.last-updated-by');
                if (lastUpdatedByElement) {
                    lastUpdatedByElement.textContent = currentUser.name;
                } else {
                    roomElement.innerHTML = `
                        <div class="last-updated-by">${currentUser.name}</div>
                        ${roomElement.innerHTML}
                    `;
                }
                
                // æ›´æ–°ç»Ÿè®¡
                renderStatsPanel();
                
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification(`æˆ¿é—´ ${roomId} çŠ¶æ€å·²æ›´æ–°ä¸º: ${newStatusInfo.name}`, 'success');
            }
        }
        
        // æ ‡è®°æ‰€æœ‰æˆ¿é—´ä¸ºæ­£å¸¸
        function markAllNormal() {
            if (!systemData || !currentUser) return;
            
            let changedCount = 0;
            
            systemData.floors.forEach(floor => {
                floor.rooms.forEach(room => {
                    if (room.type === 'dorm' && room.status !== 1) {
                        room.status = 1;
                        room.lastUpdated = new Date().toISOString();
                        room.lastUpdatedBy = currentUser.name;
                        changedCount++;
                    }
                });
            });
            
            if (changedCount > 0) {
                addActivityLog(`${currentUser.name} æ ‡è®°äº†æ‰€æœ‰æˆ¿é—´ä¸º"å·²æ£€æŸ¥ï¼Œæ­£å¸¸"`);
                saveSystemData();
                renderFloors();
                renderStatsPanel();
                syncData();
                showNotification(`å·²æ ‡è®° ${changedCount} ä¸ªæˆ¿é—´ä¸º"å·²æ£€æŸ¥ï¼Œæ­£å¸¸"`, 'success');
            }
        }
        
        // é‡ç½®æ‰€æœ‰æˆ¿é—´ä¸ºæœªæ£€æŸ¥
        function resetAll() {
            if (!systemData || !currentUser) return;
            
            let changedCount = 0;
            
            systemData.floors.forEach(floor => {
                floor.rooms.forEach(room => {
                    if (room.type === 'dorm' && room.status !== 0) {
                        room.status = 0;
                        room.lastUpdated = new Date().toISOString();
                        room.lastUpdatedBy = currentUser.name;
                        changedCount++;
                    }
                });
            });
            
            if (changedCount > 0) {
                addActivityLog(`${currentUser.name} é‡ç½®äº†æ‰€æœ‰æˆ¿é—´ä¸º"æœªæ£€æŸ¥"`);
                saveSystemData();
                renderFloors();
                renderStatsPanel();
                syncData();
                showNotification(`å·²é‡ç½® ${changedCount} ä¸ªæˆ¿é—´ä¸º"æœªæ£€æŸ¥"`, 'success');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!systemData) return;
            
            const dataStr = JSON.stringify(systemData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `SJTU_D35_å®¿èˆæ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
        }
        
        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFile').click();
        }
        
        // æ¸…é™¤æœ¬åœ°æ•°æ®
        function clearLocalData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                localStorage.removeItem('SJTU_DORM_USER_ID');
                
                // é‡æ–°åˆå§‹åŒ–ç³»ç»Ÿ
                initializeUser();
                initializeSystemData();
                renderFloors();
                renderStatsPanel();
                renderActivityLog();
                
                showNotification('æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼Œç³»ç»Ÿå·²é‡æ–°åˆå§‹åŒ–', 'info');
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                transition: opacity 0.3s;
                opacity: 0;
                max-width: 300px;
                color: white;
                font-weight: 500;
            `;
            
            // è®¾ç½®èƒŒæ™¯è‰²
            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ffc107';
                notification.style.color = '#212529';
            } else {
                notification.style.backgroundColor = '#17a2b8';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºé€šçŸ¥
            setTimeout(() => {
                notification.style.opacity = '0.9';
            }, 10);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç”¨æˆ·
            currentUser = initializeUser();
            
            // åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
            systemData = initializeSystemData();
            
            // æ¸²æŸ“é¡µé¢
            renderFloors();
            renderStatsPanel();
            renderActivityLog();
            
            // è®¾ç½®è‡ªåŠ¨åŒæ­¥
            syncTimer = setInterval(syncData, CONFIG.SYNC_INTERVAL);
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('forceSync').addEventListener('click', syncData);
            document.getElementById('changeUser').addEventListener('click', function() {
                localStorage.removeItem('SJTU_DORM_USER_ID');
                currentUser = initializeUser();
                showNotification('ç”¨æˆ·å·²åˆ‡æ¢', 'info');
            });
            
            document.getElementById('markAllNormal').addEventListener('click', markAllNormal);
            document.getElementById('resetAll').addEventListener('click', resetAll);
            
            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('importData').addEventListener('click', importData);
            document.getElementById('clearLocalData').addEventListener('click', clearLocalData);
            
            // æ–‡ä»¶å¯¼å…¥å¤„ç†
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (validateSystemData(importedData)) {
                            // ç¡®è®¤å¯¼å…¥
                            if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚')) {
                                systemData = importedData;
                                saveSystemData();
                                renderFloors();
                                renderStatsPanel();
                                renderActivityLog();
                                syncData();
                                showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                            }
                        } else {
                            showNotification('å¯¼å…¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®', 'error');
                        }
                    } catch (error) {
                        showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                e.target.value = '';
            });
            
            // åˆå§‹åŒ–åŒæ­¥çŠ¶æ€
            syncData();
            
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>